var GameUI={ANI_INTERVAL:25,ANI:false,BKGIMG_SRC:"imgs/gameBkg.png",REDIMG_SRC:"imgs/redBlock-t.png",YELLOWIMG_SRC:"imgs/yellowBlock-t.png",BLUEIMG_SRC:"imgs/blueBlock-t.png",GREENIMG_SRC:"imgs/greenBlock-t.png",BLACKIMG_SRC:"imgs/blackBlock-t.png",BKGAUDIO_OGG_SRC:"imgs/sound.ogg",BKGAUDIO_MP3_SRC:"imgs/sound.mp3",FLASH_BTN_CLASS:"btnHover",NEW_GAME_STR:"<u>N</u>ew Game",PAUSE_STR:"<u>P</u>ause",RESUME_STR:"<u>R</u>esume",NOT_RESUME_STR:"<del><u>R</u>esume</del>",MUTE_STR:"<u>M</u>ute",NOT_MUTE_STR:"<del><u>M</u>ute</del>",
HELP_STR:"<u>H</u>elp",RANK_STR:"Ran<u>k</u>",BACK_STR:"<u>B</u>ack",m_debug:$("#debug"),m_id:"",m_cubeFrame:$("#cubeFrame"),m_cubeReel:$("#cubeReel"),m_cubeMenu:$("#cubeMenu"),m_cubeGame:$("#cubeGame"),HELP_PAGE:0,RANK_PAGE:1,MENU_PAGE:2,GAME_PAGE:3,m_curPage:2,m_game:null,m_gameVector:null,m_tempVector:null,m_disQueue:null,m_timer:0,m_afterAni:null,m_debugui:$("#gameui"),m_canvas:$("#canvasGame"),m_canvasDraw:null,m_div:$("#divGame"),m_canvasNext:$("#canvasNext"),m_divScore:$("#gameScore"),m_divLevel:$("#gameLevel"),
m_divTime:$("#gameTime"),m_btnStart:$(".btnStart"),m_btnPause:$(".btnPause"),m_btnHelp:$(".btnHelp"),m_btnRank:$(".btnRank"),m_btnMute:$(".btnMute"),m_btnMenu:$(".btnMenu"),m_pPlayed:$("#playedInfo"),m_menuBtns:null,m_menuSel:-1,m_curActiveBtn:null,m_loopFlash:false,m_blocks:null,m_aniCount:0,m_bkgImg:null,m_redImg:null,m_yellowImg:null,m_blueImg:null,m_greenImg:null,m_blackImg:null,m_blockImgs:null,m_audio:null,m_curScore:0,m_curLevel:0,m_lastPlayTime:0,m_lastRank:0,m_lastList:"",m_currentList:"",
m_marginTop:0,init:function(){GameUI.changeMarginTop();$(window).resize(GameUI.changeMarginTop);if(GameUI.m_canvas.length)GameUI.m_canvas=GameUI.m_canvas[0],GameUI.m_canvasDraw=GameUI.m_canvas.getContext("2d"),GameUI.m_canvas.addEventListener("click",GameUI.gameClicked,false);if(GameUI.m_div.length){GameUI.m_blocks=Array(20);for(var a=0;a<20;++a){GameUI.m_blocks[19-a]=Array(10);var b=$("<div/>");b.addClass("line"+(19-a));for(var d=0;d<10;++d){var c=$("<div/>");c.addClass("block"+d);c.addClass("block");
c.append($("<div/>"));GameUI.m_blocks[19-a][d]=c;b.append(c)}b.append($("<div/>").addClass("clear"));GameUI.m_div.append(b)}}if(GameUI.m_canvasNext.length)GameUI.m_canvasNext=GameUI.m_canvasNext[0],GameUI.m_canvasNext=GameUI.m_canvasNext.getContext("2d");GameUI.m_btnPause.html(GameUI.PAUSE_STR);GameUI.m_btnPause.click(function(){GameUI.pauseGame()});GameUI.m_btnStart.html(GameUI.NEW_GAME_STR);GameUI.m_btnStart.click(function(){GameUI.startGame()});GameUI.m_btnMute.click(function(){GameUI.mute()});
GameUI.m_btnRank.html(GameUI.RANK_STR);GameUI.m_btnRank.click(function(){GameUI.switchToRank(false)});GameUI.m_btnHelp.html(GameUI.HELP_STR);GameUI.m_btnHelp.click(function(){GameUI.switchToHelp()});GameUI.m_btnMenu.html(GameUI.BACK_STR);GameUI.m_btnMenu.click(function(){GameUI.switchToMenu()});document.documentElement.onkeydown=function(a){a=a||window.event;a=a.which||a.keyCode;if(a==87||a==38)switch(GameUI.m_curPage){case GameUI.GAME_PAGE:GameUI.keyRotate()}else if(a==83||a==40)switch(GameUI.m_curPage){case GameUI.GAME_PAGE:GameUI.keyDown()}else a==
65||a==37?GameUI.keyLeft():a==68||a==39?GameUI.keyRight():a==88?GameUI.keyDownToBase():a==78?GameUI.m_curPage==GameUI.MENU_PAGE&&GameUI.startGame():a==80||a==82?(GameUI.pauseGame(),GameUI.flashButton(GameUI.m_btnPause,false)):a==75?GameUI.m_curPage==GameUI.MENU_PAGE&&GameUI.switchToRank(false):a==72?GameUI.m_curPage==GameUI.MENU_PAGE&&GameUI.switchToHelp():a==77?(GameUI.mute(),GameUI.flashButton(GameUI.m_btnMute,false)):a==66&&(GameUI.m_curPage==GameUI.HELP_PAGE||GameUI.m_curPage==GameUI.RANK_PAGE)&&
GameUI.switchToMenu()};window.onbeforeunload=function(){GameUI.m_game!=null&&GameUI.m_game.IsRunning()&&!GameUI.m_game.IsPaused()&&GameUI.pauseGame();return"Really Exit?"};localStorage.id?GameUI.m_id=localStorage.id:(a=Math.random(),$.ajax({type:"GET",url:"http://tetris5.sourceforge.net/ajax.php",dataType:"jsonp",data:{oper:"genid",rand:a},success:function(a){GameUI.m_id=a.data;localStorage.id=GameUI.m_id}}));$.ajax({type:"GET",url:"http://tetris5.sourceforge.net/ajax.php",dataType:"jsonp",data:{oper:"played"},
success:function(a){GameUI.m_pPlayed.html("Tetris5 has been played "+a.count+" times.<br />And totally scored "+a.sum+" points.<br />Just enjoy it!")}});GameUI.switchToMenu();GameUI.loadRes()},loadRes:function(){GameUI.loadBkgImg()},loadBkgImg:function(){GameUI.m_bkgImg=new Image;GameUI.m_bkgImg.onload=GameUI.loadRedImg;GameUI.m_bkgImg.src=GameUI.BKGIMG_SRC},loadRedImg:function(){GameUI.m_redImg=new Image;GameUI.m_redImg.onload=GameUI.loadYellowImg;GameUI.m_redImg.src=GameUI.REDIMG_SRC},loadYellowImg:function(){GameUI.m_yellowImg=
new Image;GameUI.m_yellowImg.onload=GameUI.loadBlueImg;GameUI.m_yellowImg.src=GameUI.YELLOWIMG_SRC},loadBlueImg:function(){GameUI.m_blueImg=new Image;GameUI.m_blueImg.onload=GameUI.loadGreenImg;GameUI.m_blueImg.src=GameUI.BLUEIMG_SRC},loadGreenImg:function(){GameUI.m_greenImg=new Image;GameUI.m_greenImg.onload=GameUI.loadBlackImg;GameUI.m_greenImg.src=GameUI.GREENIMG_SRC},loadBlackImg:function(){GameUI.m_blackImg=new Image;GameUI.m_blackImg.onload=GameUI.loadBkgAudio;GameUI.m_blackImg.src=GameUI.BLACKIMG_SRC},
loadBkgAudio:function(){GameUI.m_audio=new Audio;localStorage.mute==1?(GameUI.m_btnMute.html(GameUI.NOT_MUTE_STR),GameUI.m_audio.volume=0):(GameUI.m_btnMute.html(GameUI.MUTE_STR),GameUI.m_audio.volume=0.1);GameUI.m_audio.addEventListener("ended",function(){GameUI.m_audio.currentTime=0;GameUI.m_audio.play()},false);if(!$.browser.opera)GameUI.m_audio.src=Modernizr.audio.ogg?GameUI.BKGAUDIO_OGG_SRC:GameUI.BKGAUDIO_MP3_SRC,GameUI.m_audio.play();GameUI.afterLoadRes()},afterLoadRes:function(){GameUI.m_blockImgs=
[];GameUI.m_blockImgs[1]=GameUI.m_redImg;GameUI.m_blockImgs[2]=GameUI.m_yellowImg;GameUI.m_blockImgs[3]=GameUI.m_blueImg;GameUI.m_blockImgs[4]=GameUI.m_greenImg;GameUI.m_blockImgs[5]=GameUI.m_blackImg;GameUI.m_game=Game;GameUI.m_game.Init(GameUI);GameUI.m_game.ANI=GameUI.ANI;GameUI.m_game.SetAutoUp(0);GameUI.loadGame()?GameUI.m_btnPause.html(GameUI.RESUME_STR):GameUI.m_btnPause.html(GameUI.NOT_RESUME_STR);$("#menuLoading").slideUp();GameUI.repaint()},stopBubble:function(a){a=a?a:window.event;window.event?
a.cancelBubble=true:a.stopPropagation()},gameClicked:function(a){switch(GameUI.getCurPos(a)){case 0:GameUI.keyRotate();break;case 1:GameUI.keyLeft();break;case 2:GameUI.keyRight();break;case 3:GameUI.keyDownToBase()}},getCurPos:function(a){var b;a.pageX!=void 0&&a.pageY!=void 0?(b=a.pageX,a=a.pageY):(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,a=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);b-=GameUI.m_canvas.offsetLeft;a-=GameUI.m_canvas.offsetTop;
b+=GameUI.m_canvas.offsetLeft-GameUI.m_cubeFrame.get(0).offsetLeft-10;a-=GameUI.m_marginTop;return a>270?3:a<90?0:b<90?1:2},changeMarginTop:function(){var a=$("#cubeFrame"),b=a.height(),d=$(window).height();GameUI.m_marginTop=(d-b)/3;GameUI.m_marginTop=Math.ceil(GameUI.m_marginTop);a.css("margin-top",GameUI.m_marginTop+"px")},flashButton:function(a,b){a.addClass(GameUI.FLASH_BTN_CLASS);GameUI.m_curActiveBtn=a;GameUI.m_loopFlash=b;setTimeout("GameUI.removeBtnActive()",350)},loopFlash:function(){GameUI.m_curActiveBtn.addClass(GameUI.FLASH_BTN_CLASS);
setTimeout("GameUI.removeBtnActive()",400)},removeBtnActive:function(){GameUI.m_curActiveBtn&&GameUI.m_curActiveBtn.removeClass(GameUI.FLASH_BTN_CLASS)},keyRotate:function(){GameUI.m_game.IsPaused()||GameUI.m_game.KeyRotatePressed()},keyLeft:function(){GameUI.m_game.IsPaused()||GameUI.m_game.KeyLeftPressed()},keyRight:function(){GameUI.m_game.IsPaused()||GameUI.m_game.KeyRightPressed()},keyUp:function(){GameUI.m_game.IsPaused()||GameUI.m_game.KeyUpPressed()},keyDown:function(){GameUI.m_game.IsPaused()||
GameUI.m_game.KeyDownPressed()},keyDownToBase:function(){GameUI.m_game.IsPaused()||GameUI.m_game.KeyDownToBasePressed()},mute:function(){GameUI.m_audio.volume==0?(GameUI.m_audio.volume=0.1,GameUI.m_btnMute.html(GameUI.MUTE_STR),localStorage.mute=0):(GameUI.m_audio.volume=0,GameUI.m_btnMute.html(GameUI.NOT_MUTE_STR),localStorage.mute=1)},switchToHelp:function(){GameUI.m_cubeReel.animate({left:"0"},300);GameUI.m_curPage=GameUI.HELP_PAGE},switchToRank:function(a){var b=$("#rankList ul");b.hide();var d=
$("#rankNav");d.html("");if(a){var c=$("<a/>").html("Current");c.addClass("linkBtn");c.addClass("btnCurrent");c.addClass("selected");c.attr("href","#current");c.click(function(){GameUI.getResult("current")});d.append(c);d.append(" | ");b.fadeIn();var e=parseInt(GameUI.m_curScore),f=parseInt(GameUI.m_curLevel);GameUI.m_lastPlayTime=parseInt(GameUI.m_divTime.html());var g=localStorage.name?localStorage.name:"New Player",b=$("#rankList li#list1 .name"),c=$("#rankList li#list1 .result");b.html("");var h=
$("<input/>");h.addClass("inputName").attr({type:"text",maxlength:"255",value:g});h[0].onkeydown=function(a){GameUI.stopBubble(a)};g=$("<a/>").html("OK");g.addClass("linkBtn");g.addClass("btnNameSub");g.attr("href","#");g.click(function(){GameUI.postResult()});b.append(h);b.append(g);b.append("<div class='gameRank'>Rank: <span class='currentRank'></span></div>");h.focus();c.html("Score: "+e+" | Level: "+f+" | Time: "+GameUI.m_lastPlayTime);GameUI.getRank(e,f,GameUI.m_lastPlayTime);for(e=1;e<5;++e)b=
$("#rankList li#list"+(e+1)+" .name"),c=$("#rankList li#list"+(e+1)+" .result"),b.html(""),c.html("");GameUI.m_lastList="current"}b=$("<a/>").html("Total");b.addClass("linkBtn");b.addClass("btnTotal");b.attr("href","#total");b.click(function(){GameUI.getResult("total")});c=$("<a/>").html("Your Best");c.addClass("linkBtn");c.addClass("btnBest");c.attr("href","#best");c.click(function(){GameUI.getResult("best")});d.append(b);d.append(" | ");d.append(c);a||GameUI.getResult("total");GameUI.m_cubeReel.animate({left:"-290px"},
300);GameUI.m_curPage=GameUI.RANK_PAGE},switchToMenu:function(){GameUI.m_cubeReel.animate({left:"-580px"},300);GameUI.m_curPage=GameUI.MENU_PAGE},switchToGame:function(){GameUI.m_cubeReel.animate({left:"-870px"},300);GameUI.m_curPage=GameUI.GAME_PAGE},getRank:function(a,b,d){$.ajax({type:"GET",url:"http://tetris5.sourceforge.net/ajax.php",dataType:"jsonp",data:{oper:"rank",score:a,level:b,time:d},success:function(a){GameUI.m_lastRank=parseInt(a.data);$(".currentRank").html(GameUI.m_lastRank)}})},
getResult:function(a){var b=$("#rankList ul");b.hide();var d=$(".btnCurrent"),c=$(".btnTotal"),e=$(".btnBest");a=="total"?(c.addClass("selected"),e.removeClass("selected"),d.removeClass("selected")):a=="best"?(e.addClass("selected"),c.removeClass("selected"),d.removeClass("selected")):a=="current"&&(d.addClass("selected"),c.removeClass("selected"),e.removeClass("selected"));if(a!="current"){if(GameUI.m_lastList=="current")GameUI.postResult(),GameUI.m_currentList=b.html();$.ajax({type:"GET",url:"http://tetris5.sourceforge.net/ajax.php",
dataType:"jsonp",data:{oper:a,id:GameUI.m_id},success:function(a){GameUI.displayResult(a)}})}else b.html(GameUI.m_currentList),$("#rankList ul").fadeIn();GameUI.m_lastList=a},displayResult:function(a){if(a!=null){for(var b=0,d=a.length;b<5;++b){var c=$("#rankList li#list"+(b+1)+" .name"),e=$("#rankList li#list"+(b+1)+" .result");if(b<d){var f=a[b],g=f.name,h=f.rank?f.rank:"",i=f.score,j=f.level,f=f.play_time,h="Rank: "+h;c.html(g+"<div class='gameRank'>"+h+"</div>");e.html("Score: "+i+" | Level: "+
j+" | Time: "+f)}else c.html(""),e.html("")}$("#rankList ul").fadeIn()}},postResult:function(){var a=parseInt(GameUI.m_curScore),b=parseInt(GameUI.m_curLevel),d=parseInt(GameUI.m_lastPlayTime),c=localStorage.name?localStorage.name:"New Player",e=GameUI.m_lastRank<1?"":GameUI.m_lastRank,c=$(".inputName");if(c.length!=0){var f=$("#rankList li#list1 .name"),c=c.val();namehtml=$("<div/>").text(c).html();localStorage.name=c;f.html(namehtml+"<div class='gameRank'>Rank: <span class='currentRank'>"+e+"</span></div>");
$.ajax({type:"GET",url:"http://tetris5.sourceforge.net/ajax.php",dataType:"jsonp",data:{oper:"result",id:GameUI.m_id,name:c,score:a,level:b,playTime:d}})}},startGame:function(){GameUI.switchToGame();GameUI.m_game.Init(GameUI);GameUI.m_game.ANI=GameUI.ANI;GameUI.m_game.SetAutoUp(0);GameUI.m_game.Start();GameUI.m_btnPause.html(GameUI.PAUSE_STR)},pauseGame:function(){if((GameUI.m_btnPause.html()==GameUI.PAUSE_STR||GameUI.m_btnPause.html()==GameUI.RESUME_STR)&&GameUI.m_game!=null&&!GameUI.m_game.IsGameOver())GameUI.m_game.IsPaused()&&
GameUI.switchToGame(),GameUI.m_game.Pause(),GameUI.m_game.IsPaused()?(GameUI.switchToMenu(),GameUI.m_btnPause.html(GameUI.RESUME_STR),GameUI.saveGame()):GameUI.m_btnPause.html(GameUI.PAUSE_STR)},stopedGame:function(){GameUI.switchToRank(true);GameUI.m_btnPause.html(GameUI.NOT_RESUME_STR);GameUI.clearSavedGame()},paint:function(){if(GameUI.m_canvasDraw.fillRect){GameUI.m_canvasDraw.fillStyle="white";GameUI.m_canvasDraw.fillRect(0,0,180,360);for(var a=0;a<10;++a)GameUI.m_canvasDraw.drawImage(GameUI.m_bkgImg,
0,0)}for(var a=0,b=19;b>=0;--b)for(a=0;a<10;++a){var d=GameUI.m_gameVector[a][b];d>0?(GameUI.m_canvasDraw.fillRect&&GameUI.m_canvasDraw.drawImage(GameUI.m_blockImgs[d],a*18,(19-b)*18),GameUI.m_div.length&&GameUI.m_blocks[b][a].addClass("blockColor"+GameUI.m_gameVector[a][b])):GameUI.m_div.length&&(GameUI.m_blocks[b][a].removeClass("blockColor1"),GameUI.m_blocks[b][a].removeClass("blockColor2"),GameUI.m_blocks[b][a].removeClass("blockColor3"),GameUI.m_blocks[b][a].removeClass("blockColor4"),GameUI.m_blocks[b][a].removeClass("blockColor5"))}if(!GameUI.m_game.isEffecting()){GameUI.m_canvasNext.fillStyle=
"white";GameUI.m_canvasNext.fillRect(0,0,72,36);var a=GameUI.m_game.GetNext(),d=a.array,c=0;a.type>=2&&(c=9);a=0;for(b=1;b>=0;--b)for(a=0;a<4;++a)d[a][b]&&GameUI.m_canvasNext.drawImage(GameUI.m_blockImgs[5],a*18+c,(1-b)*18);GameUI.m_curScore!=GameUI.m_game.GetScore()?(GameUI.m_curScore=GameUI.m_game.GetScore(),GameUI.m_divScore.animate({color:"white"},250,function(){GameUI.m_divScore.html(GameUI.m_curScore);GameUI.m_divScore.animate({color:"black"},250)})):GameUI.m_curScore==0&&GameUI.m_divScore.html(GameUI.m_curScore);
GameUI.m_curLevel!=GameUI.m_game.GetLevel()?(GameUI.m_curLevel=GameUI.m_game.GetLevel(),GameUI.m_divLevel.animate({color:"white"},250,function(){GameUI.m_divLevel.html(GameUI.m_curLevel);GameUI.m_divLevel.animate({color:"black"},250)})):GameUI.m_curLevel==0&&GameUI.m_divLevel.html(GameUI.m_curLevel);GameUI.m_divTime.html(GameUI.m_game.GetPlayingTime())}},repaint:function(){GameUI.m_gameVector=GameUI.m_game.Display();GameUI.m_debugui.val(GameUI.m_gameVector);GameUI.paint()},setAni:function(a){GameUI.ANI=
a},dispearLinesEffect:function(a,b,d){GameUI.m_afterAni=d;GameUI.m_tempVector=b;GameUI.m_disQueue=a;GameUI.m_aniCount=0;GameUI.m_timer=setTimeout("GameUI.aniDis()",GameUI.ANI_INTERVAL)},aniDis:function(){for(var a=GameUI.m_disQueue.length,b=0;b<a;b++)GameUI.m_tempVector[GameUI.m_aniCount][GameUI.m_disQueue[b]]=0;GameUI.m_gameVector=GameUI.m_tempVector;GameUI.paint();++GameUI.m_aniCount;GameUI.m_aniCount<10?GameUI.m_timer=setTimeout("GameUI.aniDis()",GameUI.ANI_INTERVAL):(clearTimeout(GameUI.m_timer),
GameUI.m_afterAni(GameUI.m_disQueue,a))},loadGame:function(){if(!Modernizr.localstorage)return false;if(localStorage.m_cumulativeTime>0){for(var a=0;a<10;++a){GameUI.m_game.m_ground[a]=Array(20);for(var b=0;b<20;++b)GameUI.m_game.m_ground[a][b]=parseInt(localStorage["m_ground."+a+"."+b])}for(a=0;a<10;++a){GameUI.m_game.m_base[a]=Array(23);for(b=0;b<23;++b)GameUI.m_game.m_base[a][b]=parseInt(localStorage["m_base."+a+"."+b])}a=new Pos;a.x=parseInt(localStorage["m_curBlock.pos.x"]);a.y=parseInt(localStorage["m_curBlock.pos.y"]);
GameUI.m_game.m_curBlock=new Block(parseInt(localStorage["m_curBlock.blockType"]),a);GameUI.m_game.m_curBlock.style=parseInt(localStorage["m_curBlock.style"]);GameUI.m_game.m_curBlock.color=parseInt(localStorage["m_curBlock.color"]);GameUI.m_game.m_iScore=parseInt(localStorage.m_iScore);GameUI.m_game.m_nLevel=parseInt(localStorage.m_nLevel);GameUI.m_game.m_nInitLevel=parseInt(localStorage.m_nInitLevel);GameUI.m_game.m_nextType=parseInt(localStorage.m_nextType);GameUI.m_game.m_isAutoUpBase=parseInt(localStorage.m_isAutoUpBase);
GameUI.m_game.m_curColor=parseInt(localStorage.m_curColor);GameUI.m_game.m_cumulativeTime=parseInt(localStorage.m_cumulativeTime);GameUI.m_game.m_gameUI=GameUI;GameUI.m_game.m_running=true;GameUI.m_game.m_paused=true;GameUI.m_game.DownThread();return true}return false},saveGame:function(){if(Modernizr.localstorage){for(var a=0;a<10;++a)for(var b=0;b<20;++b)localStorage["m_ground."+a+"."+b]=GameUI.m_game.m_ground[a][b];for(a=0;a<10;++a)for(b=0;b<23;++b)localStorage["m_base."+a+"."+b]=GameUI.m_game.m_base[a][b];
localStorage["m_curBlock.blockType"]=GameUI.m_game.m_curBlock.blockType;localStorage["m_curBlock.pos.x"]=GameUI.m_game.m_curBlock.pos.x;localStorage["m_curBlock.pos.y"]=GameUI.m_game.m_curBlock.pos.y;localStorage["m_curBlock.style"]=GameUI.m_game.m_curBlock.style;localStorage["m_curBlock.color"]=GameUI.m_game.m_curBlock.color;localStorage.m_iScore=GameUI.m_game.m_iScore;localStorage.m_nLevel=GameUI.m_game.m_nLevel;localStorage.m_nInitLevel=GameUI.m_game.m_nInitLevel;localStorage.m_nextType=GameUI.m_game.m_nextType;
localStorage.m_isAutoUpBase=GameUI.m_game.m_isAutoUpBase;localStorage.m_curColor=GameUI.m_game.m_curColor;localStorage.m_cumulativeTime=GameUI.m_game.m_cumulativeTime}},clearSavedGame:function(){localStorage.m_cumulativeTime=-1}};
